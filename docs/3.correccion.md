# Corrección de errores detectados en la Migración a Spring Boot

Luego de realizar la migración con OpenRewrite, es necesario revisar si alguna de las pruebas falla y corregir el código. En algunos casos, para solucionar los problemas de las pruebas, puede ser necesario modificar el código de la aplicación, cambiar librerías y dependencias que OpenRewrite no pudo migrar o cambiar el código de las pruebas cuando estas pruebas deben corregirse.

> **NOTA:**  A continuación se muestran los errores detectados en la migración 
> a Spring Boot 3.x, tal como resultó el 10 de Mayo de 2025

---

## Determinando los errores detectados luego de la migración

1. Revise los resultados de ejecutra las pruebas de regresión

    ```
    # en la terminal
    mvn test
    ```

    Al migrar a Spring Boot 3.0.13, cuando se ejecutan las pruebas de regresión, se detectan dos pruebas que no funcionan:

    | Clase          | Método                                | Error      |
    |----------------|---------------------------------------|------------|
    | ValidatorTests | shouldNotValidateWhenFirstNameEmpty() | expected: "may not be empty" but was: "must not be empty" |
    | VetControllerTests | testShowResourcesVetList() | Content type expected:[application/json;charset=UTF-8] but was:[application/json] |


## Solucionando el error de `expected: "may not be empty" but was: "must not be empty"`.

El error ocurre debido a que el mensaje de Validación cambió de una versión a otra de Spring Boot.
- El mensaje de validación en `org.hibernate.validator` era `may not be empty`
- Y el mensaje de validación en `jakarta.validation` es `must not be empty`
- la solución es modificar la prueba y revisar el mensaje de validación que se utiliza en la nueva versión
  
---

2. Modifique la prueba para hacer la validación con el nuevo mensaje 

   ```
    @Test
    public void shouldNotValidateWhenFirstNameEmpty() {

        LocaleContextHolder.setLocale(Locale.ENGLISH);
        Person person = new Person();
        person.setFirstName("");
        person.setLastName("smith");

        Validator validator = createValidator();
        Set<ConstraintViolation<Person>> constraintViolations = validator.validate(person);

        assertThat(constraintViolations.size()).isEqualTo(1);
        ConstraintViolation<Person> violation = constraintViolations.iterator().next();
        assertThat(violation.getPropertyPath().toString()).isEqualTo("firstName");
        assertThat(violation.getMessage()).isEqualTo("must not be empty");
    }
   ```



## Solucione el error de `Content type expected:[application/json;charset=UTF-8] but was:[application/json]` 

El error ocurre debido a que, por defecto, el controlador responde a las solicitudes REST con  el encabezado `Content-type` con `application/json` y no con `application/json;charset=UTF-8`
- Spring Boot 1.x soportaba el RFC 7159, pero esta norma ha sido reemplazada por RFC 8259 
- una solución puede ser cambiar la respuesta para que use el encoding de `charset=UTF-8`
- otra solución podría ser cambiar la prueba para usar los valores por defecto
- la mejor solución es comparar el resultado con alguna de las constantes definidas en Java, que cambia con cada nuevo RFC, en lugar de depender de una cadena de texto

---

3. Una alternativa es ejecutar OpenRewrite usando la receta de `ReplaceStringLiteralsWithMediaTypeConstants`

    Modificando el `pom.xml`, colocando la receta en la sección de openRewrite

    ```
      <plugin>
        <groupId>org.openrewrite.maven</groupId>
        <artifactId>rewrite-maven-plugin</artifactId>
        <version>6.8.0</version>
        <configuration>
          <exportDatatables>true</exportDatatables>
          <activeRecipes>
            <recipe>
              org.openrewrite.java.spring.http.ReplaceStringLiteralsWithMediaTypeConstants
            </recipe>
          </activeRecipes>
        </configuration>
        <dependencies>
          <dependency>
            <groupId>org.openrewrite.recipe</groupId>
            <artifactId>rewrite-spring</artifactId>
            <version>6.7.0</version>
          </dependency>
        </dependencies>
      </plugin>    
    ```

    y ejecutando la receta usando `mvn rewrite:run`

    ```
    # en la terminal
    mvn rewrite:run
    ```

4. Otra alternativa es ejecutar la receta de OpenRewrite desde línea de comandos sin modificar el archivo `pom.xml` 

    ```
    # en la terminal
    mvn -U org.openrewrite.maven:rewrite-maven-plugin:run -Drewrite.activeRecipes=org.openrewrite.java.spring.http.ReplaceStringLiteralsWithMediaTypeConstants
    ```

5. Finalmente, otra alternativa es modificar el código de la prueba en el archivo `src/test/java/org/springframework/samples/petclinic/vet/VetControllerTests.java`.

    Reemplace la cadena `"application/json;charset=UTF-8"` por la constante `MediaType.APPLICATION_JSON`. 

    ```
    @Test
    public void testShowResourcesVetList() throws Exception {
        ResultActions actions = mockMvc.perform(get("/vets.json").accept(MediaType.APPLICATION_JSON))
            .andExpect(status().isOk());
        actions.andExpect(content().contentType(MediaType.APPLICATION_JSON))
            .andExpect(jsonPath("$.vetList[0].id").value(1));
    }
    ```


## Ejecutando pruebas de regresión

4. Ejecute nuevamente las pruebas de regresión

    ```
    # en la terminal
    mvn test
    ```

